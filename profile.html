<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Profile — Electric Ink</title>
    <link rel="stylesheet" href="/css/main.css">
  </head>
  <body>
    <main class="container">
      <h1>My Profile</h1>
      <div id="authArea">
        <form id="authForm">
          <label>Email <input id="email" type="email" required></label>
          <label>Password <input id="password" type="password" required></label>
          <button id="signInBtn">Sign in</button>
          <button id="signUpBtn" type="button">Create my account</button>
          <button id="signOutBtn" type="button" style="display:none">Sign out</button>
        </form>
      </div>

      <section id="profile" style="display:none">
        <h2>Account</h2>
        <p id="profileInfo"></p>
        <h3>Orders</h3>
        <div id="orders"></div>
      </section>
    </main>

    <script src="/js/firebase-client-config.js" defer></script>
    <script type="module">
      import { initAuth, signIn, signUp, signOutUser, onAuthChange, getCurrentUser } from './js/auth.js';
      import { getUserOrdersByEmail } from './js/orders.js';

      async function boot() {
        try {
          await initAuth();
        } catch (e) {
          console.error('Firebase init failed', e);
          return;
        }

        const emailEl = document.getElementById('email');
        const passwordEl = document.getElementById('password');
        const signInBtn = document.getElementById('signInBtn');
        const signUpBtn = document.getElementById('signUpBtn');
        const signOutBtn = document.getElementById('signOutBtn');
        const profile = document.getElementById('profile');
        const profileInfo = document.getElementById('profileInfo');
        const ordersEl = document.getElementById('orders');

        signInBtn.addEventListener('click', async (ev) => {
          ev.preventDefault();
          try { await signIn(emailEl.value, passwordEl.value); } catch (err) { alert(err.message); }
        });

        signUpBtn.addEventListener('click', async (ev) => {
          ev.preventDefault();
          try { await signUp(emailEl.value, passwordEl.value); } catch (err) { alert(err.message); }
        });

        signOutBtn.addEventListener('click', async () => { await signOutUser(); });

        onAuthChange(async (user) => {
          if (user) {
            document.getElementById('authForm').style.display = 'none';
            signOutBtn.style.display = 'inline-block';
            profile.style.display = 'block';
            profileInfo.textContent = `Signed in as ${user.email}`;
            // Load orders (if rules allow querying by email)
            try {
              const orders = await getUserOrdersByEmail(user.email);
              ordersEl.innerHTML = orders.map(o => `<div class="order">${o.orderId || o.id} — €${(o.total || o.total_cents/100 || o.amount/100) }</div>`).join('');
            } catch (e) {
              ordersEl.textContent = 'Could not load orders (check rules).';
            }
          } else {
            document.getElementById('authForm').style.display = 'block';
            signOutBtn.style.display = 'none';
            profile.style.display = 'none';
          }
        });
      }

      boot();
    </script>
  </body>
</html>
